// Narang Education - Core Application (Modified for External Data)
// Remove the large gameData object and replace with:

let gameData = {}; // Will be populated from GitHub

// Modify the showCategorySelection function:
async function showCategorySelection() {
    const list = document.getElementById('class-list');
    list.innerHTML = "<div class='loading-indicator'>Memuat kategori...</div>";
    
    try {
        // Ensure data is loaded
        if (Object.keys(gameData).length === 0) {
            await window.loadNarangData();
        }
        
        list.innerHTML = "";
        
        categoryConfig.forEach((cat, index) => {
            if (gameData[cat.id]) {
                const item = document.createElement('div');
                item.className = `nr-class-card ${cat.cls}`;
                item.innerHTML = `<span class="nr-class-title">${cat.label}</span><span class="nr-class-icon"><svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7" /></svg></span>`;
                item.onclick = () => showTopicSelection(cat.id);
                list.appendChild(item);
            }
        });
        
        switchScreen('screen-class');
    } catch (error) {
        showCustomPopup('âŒ', 'Gagal Memuat', 'Tidak dapat memuat data kategori. Periksa koneksi internet.');
    }
}

// Modify the showTopicSelection function:
function showTopicSelection(catId) {
    const list = document.getElementById('topic-list');
    list.innerHTML = "";
    
    const topics = gameData[catId];
    if (topics) {
        topics.forEach(t => {
            const item = document.createElement('div');
            item.className = 'nr-list-item';
            item.innerHTML = `<span class="nr-list-title">${t.title}</span>`;
            item.onclick = () => showStudyScreen(t);
            list.appendChild(item);
        });
    }
    switchScreen('screen-topic');
}

// Modify the showStudyScreen to handle HTML content:
function showStudyScreen(topicData) {
    session.topic = topicData.title;
    session.summary = topicData.summary || "Pelajari materi ini.";
    session.qList = [...(topicData.questions || [])];
    
    document.getElementById('study-title').innerText = topicData.title;
    
    // Use innerHTML instead of innerText for formatted content
    const studyTextEl = document.getElementById('study-text');
    studyTextEl.innerHTML = session.summary;
    
    // Initialize images to load properly
    setTimeout(() => {
        studyTextEl.querySelectorAll('img').forEach(img => {
            img.style.opacity = '0';
            img.onload = () => img.style.opacity = '1';
            img.onerror = () => img.style.display = 'none';
        });
    }, 100);
    
    switchScreen('screen-study');
}

// Modify quiz and flashcard functions to handle HTML:
function loadQuizLevel() {
    // ... existing code ...
    document.getElementById('qz-question').innerHTML = qData.q; // Use innerHTML
    // ... rest of the code ...
}

function loadFlashcard() {
    // ... existing code ...
    document.getElementById('flash-front').innerHTML = frontContent;
    document.getElementById('flash-back').innerHTML = backContent;
    // ... rest of the code ...
}

// Add CSS for loading states and error handling
const additionalStyles = `
#narang-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;
}

.loading-content {
    text-align: center;
    color: white;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.2em;
    margin-top: 15px;
}

.narang-error {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
}

.error-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

.error-content h3 {
    color: #e74c3c;
    margin-bottom: 15px;
}

.error-content button {
    margin: 5px;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
}

.error-content button:first-of-type {
    background: #3498db;
    color: white;
}

.error-content button:last-of-type {
    background: #e74c3c;
    color: white;
}

.loading-indicator {
    text-align: center;
    padding: 30px;
    color: #666;
    font-style: italic;
}
`;

// Inject additional styles
const styleEl = document.createElement('style');
styleEl.textContent = additionalStyles;
document.head.appendChild(styleEl);
